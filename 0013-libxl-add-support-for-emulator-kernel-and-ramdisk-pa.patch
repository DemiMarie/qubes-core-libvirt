From 7851be6f2c93855bda943921963682a2a8a1c9bf Mon Sep 17 00:00:00 2001
From: Dmitry Fedorov <d.fedorov@tabit.pro>
Date: Wed, 13 Apr 2022 16:19:49 +0200
Subject: [PATCH] libxl: add support for emulator' kernel and ramdisk path
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Add ability to configure emulator kernel and ramdisk path.

Signed-off-by: Dmitry Fedorov <d.fedorov@tabit.pro>
Signed-off-by: Marek Marczykowski-GÃ³recki <marmarek@invisiblethingslab.com>
---
 docs/schemas/domaincommon.rng | 20 ++++++++++++++++++++
 src/conf/domain_conf.c        |  6 ++++++
 src/conf/domain_conf.h        |  2 ++
 src/libxl/libxl_conf.c        | 19 +++++++++++++++++++
 4 files changed, 47 insertions(+)

diff --git a/docs/schemas/domaincommon.rng b/docs/schemas/domaincommon.rng
index bd12c24924..dcdc63e012 100644
--- a/docs/schemas/domaincommon.rng
+++ b/docs/schemas/domaincommon.rng
@@ -3502,6 +3502,16 @@
               <ref name="memoryKB"/>
             </attribute>
           </optional>
+          <optional>
+            <attribute name="kernel">
+              <ref name="absFilePath"/>
+            </attribute>
+          </optional>
+          <optional>
+            <attribute name="ramdisk">
+              <ref name="absFilePath"/>
+            </attribute>
+          </optional>
           <ref name="absFilePath"/>
         </group>
         <group>
@@ -3517,6 +3527,16 @@
               <ref name="memoryKB"/>
             </attribute>
           </optional>
+          <optional>
+            <attribute name="kernel">
+              <ref name="absFilePath"/>
+            </attribute>
+          </optional>
+          <optional>
+            <attribute name="ramdisk">
+              <ref name="absFilePath"/>
+            </attribute>
+          </optional>
           <empty/>
         </group>
       </choice>
diff --git a/src/conf/domain_conf.c b/src/conf/domain_conf.c
index 7f810e10e9..6c604338a9 100644
--- a/src/conf/domain_conf.c
+++ b/src/conf/domain_conf.c
@@ -3539,6 +3539,8 @@ void virDomainDefFree(virDomainDefPtr def)
     virBitmapFree(def->cpumask);
     VIR_FREE(def->emulator);
     VIR_FREE(def->emulator_cmdline);
+    VIR_FREE(def->emulator_kernel);
+    VIR_FREE(def->emulator_ramdisk);
     VIR_FREE(def->description);
     VIR_FREE(def->title);
     VIR_FREE(def->hyperv_vendor_id);
@@ -21680,6 +21682,8 @@ virDomainDefParseXML(xmlDocPtr xml,
         }
     }
     def->emulator_cmdline = virXPathString("string(./devices/emulator/@cmdline)", ctxt);
+    def->emulator_kernel = virXPathString("string(./devices/emulator/@kernel)", ctxt);
+    def->emulator_ramdisk = virXPathString("string(./devices/emulator/@ramdisk)", ctxt);
 
     n = virXPathULong("string(./devices/emulator/@memory)",
                       ctxt,
@@ -30032,6 +30036,8 @@ virDomainDefFormatInternalSetRootName(virDomainDefPtr def,
         if (def->emulator_memory != 0)
             virBufferAsprintf(buf, " memory='%lu'", def->emulator_memory);
         virBufferEscapeString(buf, " cmdline='%s'", def->emulator_cmdline);
+        virBufferEscapeString(buf, " kernel='%s'", def->emulator_kernel);
+        virBufferEscapeString(buf, " ramdisk='%s'", def->emulator_ramdisk);
         if (!def->emulator) {
             virBufferAddLit(buf, "/>\n");
         } else {
diff --git a/src/conf/domain_conf.h b/src/conf/domain_conf.h
index 5d55759086..71e79db091 100644
--- a/src/conf/domain_conf.h
+++ b/src/conf/domain_conf.h
@@ -2566,6 +2566,8 @@ struct _virDomainDef {
     char *emulator;
     virDomainEmulatorType emulator_type;
     char *emulator_cmdline;
+    char *emulator_kernel;
+    char *emulator_ramdisk;
     unsigned long emulator_memory;
     /* Most {caps_,hyperv_,kvm_,}feature options utilize a virTristateSwitch
      * to handle support. A few assign specific data values to the option.
diff --git a/src/libxl/libxl_conf.c b/src/libxl/libxl_conf.c
index 14d97e34c5..7e9adf57c1 100644
--- a/src/libxl/libxl_conf.c
+++ b/src/libxl/libxl_conf.c
@@ -629,6 +629,25 @@ libxlMakeDomBuildInfo(virDomainDefPtr def,
             }
         }
 
+        if (def->emulator_kernel) {
+            if (!virFileExists(def->emulator_kernel)) {
+                virReportError(VIR_ERR_CONFIG_UNSUPPORTED,
+                               _("emulator's kernel '%s' not found"),
+                               def->emulator_kernel);
+                return -1;
+            }
+	    b_info->stubdomain_kernel = g_strdup(def->emulator_kernel);
+	}
+        if (def->emulator_ramdisk) {
+            if (!virFileExists(def->emulator_ramdisk)) {
+                virReportError(VIR_ERR_CONFIG_UNSUPPORTED,
+                               _("emulator's ramdisk '%s' not found"),
+                               def->emulator_ramdisk);
+                return -1;
+            }
+	    b_info->stubdomain_ramdisk = g_strdup(def->emulator_ramdisk);
+	}
+
         if (def->emulator_memory != 0)
             b_info->stubdomain_memkb = def->emulator_memory;
 
-- 
2.35.1

